#!/usr/bin/env sh
# Husky pre-commit (Husky v9+ 推荐: 不再 source husky.sh，避免 v10 失效警告)
set -e

echo "Running pre-commit checks..."

# 确保本地 node_modules/.bin 在 PATH（Git Bash / Windows 下常缺失）
PATH="$PWD/node_modules/.bin:$PATH"
export PATH

if [ ! -d "node_modules" ]; then
    echo "❌ node_modules 不存在，请先执行: npm install && npm run install:all" >&2
    exit 1
fi

# 直接调用脚本：内部已包含 eslint / buf / webview lint
echo "Running lint (npm run lint)..."
if ! npm run -s lint; then
    echo "❌ Lint failed." >&2
    exit 1
fi

# Prettier (lint-staged)
echo "Running Prettier (lint-staged)..."
if ! npx lint-staged --verbose; then
    echo "❌ Prettier (lint-staged) failed." >&2
    exit 1
fi

echo "✅ All checks passed!"
